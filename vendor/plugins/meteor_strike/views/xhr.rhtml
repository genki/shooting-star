<div style="position: absolute;
  <%- if options[:debug] -%>
    top: 0px; right: 0px;
  <%- else -%>
    top: -99999px; left: -99999px;
  <%- end -%>">
  <iframe id="<%= iframe_id %>" name="<%= iframe_id %>"></iframe>
  <form id="<%= iframe_id %>-form" target="<%= iframe_id %>" method="POST"
    action="http://<%= shooting_star_uri %>">
    <input name="execute" value="<%= uri %>/meteor/strike" />
    <input name="tag" /><input name="uid" /><input name="sig" />
  </form>
  <%= javascript_tag %Q{
    var meteorStrike = meteorStrike || $H();
    meteorStrike.getFlashVersion = function(){
      if(#{options[:noflash].to_json}) return 0;
      var version = 0, ua = navigator.userAgent;
      if(navigator.plugins && navigator.mimeTypes.length){
        var x = navigator.plugins["Shockwave Flash"];
        if(x && x.description) {
          version = parseInt(x.description.replace(/([a-zA-Z]|\\s)+/, ""
            ).replace(/(\\s+r|\\s+b[0-9]+)/, ".").split(".")[0]);
        }
      }else if(!ua || ua.indexOf("Windows CE") == -1){
        try{
          var axo = new ActiveXObject("ShockwaveFlash.ShockwaveFlash");
          try{
            axo.AllowScriptAccess = 'always';
            version = axo.GetVariable('$version').split(' ')[1].split(",")[0];
          }catch(e){version = 6}
        }catch(e){}
      }
      return version;
    };
    (function(){
      var channel = #{channel.to_json};
      var UID = #{uid.to_json}, TAGS = #{tags.to_json};
      var encodeTags = function(tags){
        var encode = function(i){return encodeURIComponent(i)};
        return $A(tags).uniq().map(encode).join(',');
      };
      var ms = meteorStrike[channel] = meteorStrike[channel] || new Object;
      ms.getTags = function(){return TAGS};
      ms.getUid = function(){return UID};
      ms.execute = function(js){eval(js)};
      ms.event = function(params){
        if(params.event == 'init'){
          if(ms.connection) return Element.remove('#{iframe_id}');
          ms.connection = params.type;
        }
        (function(){#{options[:event]}})();
      };
      ms.update = function(uid, tags){
        new Ajax.Request(#{update_uri.to_json}, {postBody: $H({
          channel: channel, uid: uid || UID,
          tag: encodeTags(tags || TAGS), sig: #{sig.to_json}
        }).toQueryString(), asynchronous: true});
        UID = uid, TAGS = tags;
      };
      ms.tuneIn = function(tags){
        ms.update(UID, TAGS.concat(tags || []).uniq());
      };
      ms.tuneOut = function(tags){
        ms.update(UID, Array.prototype.without.apply(TAGS, tags));
      };
      ms.tuneInOut = function(tagsIn, tagsOut){
        var tags = TAGS.concat(tagsIn || []).uniq();
        ms.update(UID, Array.prototype.without.apply(tags, tagsOut));
      };
      ms.tuneOutIn = function(tagsOut, tagsIn){
        var tags = Array.prototype.without.apply(TAGS, tagsOut);
        ms.update(UID, tags.concat(tagsIn || []).uniq());
      };
      /*setTimeout(ms.connector = function(){ 
        if(ms.connection) return;
        var form = $("#{iframe_id}-form");
        form.uid.value = #{uid.to_json};
        form.tag.value = #{tag.to_json};
        form.sig.value = #{sig.to_json};
        form.submit();
        setTimeout(ms.connector, 3000);
      }, meteorStrike.getFlashVersion() >= 6 ? 3000 : 0);
      */
    })();
    function meteor_strike_#{@meteor_strike}_DoFSCommand(command, args){
      var ms = meteorStrike[#{channel.to_json}];
      switch(command){
      case 'execute': ms.execute(args); break;
      case 'event':
        if(args == 'connect') ms.event({event: 'init', type: 'flash'});
        break;
      }
    }
    if(navigator.appName && navigator.appName.indexOf("Microsoft") != -1 &&
      navigator.userAgent.indexOf("Windows") != -1 &&
      navigator.userAgent.indexOf("Windows 3.1") == -1){
      document.write([
        '<script language="VBScript"\\>',
        'On Error Resume Next',
        ['Sub meteor_strike_', #{@meteor_strike},
         '_FSCommand(ByVal command, ByVal args)'].join(''),
        ['  Call meteor_strike_', #{@meteor_strike},
         '_DoFSCommand(command, args)'].join(''),
        'End Sub', '</script\\>'].join(#{"\n".to_json}));
    }
    if(meteorStrike.getFlashVersion() >= 6){
      document.write(#{@flash_html.to_json});
    }
  } %>
</div>
